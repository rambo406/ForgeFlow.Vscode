<section style="padding:16px; display:flex; flex-direction:column; gap:16px;">
  <header style="display:flex; align-items:center; gap:12px;">
    <vscode-button appearance="secondary" (click)="backToDashboard()">
      ‚Üê Back
    </vscode-button>
    <h2 style="margin:0; font-weight:600;">Pull Request Detail</h2>
  </header>

  <ng-container *ngIf="loading(); else content">
    <div style="display:flex; align-items:center; gap:8px;">
      <vscode-progress-ring></vscode-progress-ring>
      <span>Loading pull request‚Ä¶</span>
    </div>
  </ng-container>

  <ng-template #content>
    <ng-container *ngIf="pr(); else noData">
      <div style="display:flex; flex-direction:column; gap:8px;">
        <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
          <h3 style="margin:0;">{{ pr()?.title }}</h3>
          <vscode-badge *ngIf="pr()?.isDraft" appearance="secondary">Draft</vscode-badge>
          <vscode-badge>{{ pr()?.status }}</vscode-badge>
        </div>
        <div style="color: var(--vscode-descriptionForeground); font-size:12px;">
          <span>by {{ pr()?.author }}</span>
          <span> ‚Ä¢ {{ pr()?.repository }}</span>
          <span> ‚Ä¢ {{ branchSummary() }}</span>
          <span> ‚Ä¢ {{ pr()?.createdDate | date:'medium' }}</span>
        </div>
        <div style="white-space:pre-wrap; border:1px solid var(--vscode-panel-border,#333); padding:8px; border-radius:4px; background: var(--vscode-editor-background);">
          {{ pr()?.description || 'No description provided.' }}
        </div>

        <div *ngIf="stats()" style="display:flex; gap:8px; flex-wrap:wrap;">
          <vscode-badge appearance="secondary">Files: {{ stats()?.totalFiles }}</vscode-badge>
          <vscode-badge appearance="secondary">+{{ stats()?.totalAdditions }}</vscode-badge>
          <vscode-badge appearance="secondary">-{{ stats()?.totalDeletions }}</vscode-badge>
          <a *ngIf="pr()?.url" [href]="pr()?.url" target="_blank" style="margin-left:auto; text-decoration:none;">
            <vscode-button appearance="secondary">Open in Azure DevOps</vscode-button>
          </a>
        </div>

        <vscode-divider></vscode-divider>

        <h4 style="margin:0;">Changed Files</h4>
        <div *ngIf="fileChanges().length === 0" style="color: var(--vscode-descriptionForeground);">No file changes.</div>

        <div style="display:flex; gap:12px;">
          <!-- File list -->
          <div style="flex: 0 0 380px; display:flex; flex-direction:column; gap:6px; max-height:420px; overflow:auto;">
            <div style="display:flex; align-items:center; gap:8px;">
              <input type="checkbox" id="selectAll" (change)="selectAll($event.target.checked)"/>
              <label for="selectAll" style="font-size:12px; color: var(--vscode-descriptionForeground);">Select all</label>
            </div>

<<<<<<< HEAD
            <div *ngFor="let fc of fileChanges()" 
                 style="display:flex; align-items:center; gap:8px; padding:6px 8px; border:1px solid var(--vscode-panel-border,#333); border-radius:4px; cursor:pointer; background: var(--vscode-editor-background);"
                 (click)="showDiff(fc)">
              <input type="checkbox" [checked]="isSelected(fc)" (click)="$event.stopPropagation()" (change)="toggleFileSelection(fc)"/>
              <vscode-badge appearance="secondary">{{ fc.changeType }}</vscode-badge>
              <code style="font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">{{ fc.filePath }}</code>
              <vscode-badge *ngIf="fc.commentCount && fc.commentCount > 0" appearance="secondary" title="Comments">üí¨ {{ fc.commentCount }}</vscode-badge>
              <span style="margin-left:auto; color: var(--vscode-descriptionForeground); font-size:12px;">+{{ fc.addedLines }} / -{{ fc.deletedLines }}</span>
=======
            <div *ngFor="let fc of fileChanges()" style="display:flex; flex-direction:column; gap:4px;">
              <div 
                   style="display:flex; align-items:center; gap:8px; padding:6px 8px; border:1px solid var(--vscode-panel-border,#333); border-radius:4px; cursor:pointer; background: var(--vscode-editor-background);"
                   (click)="showDiff(fc)">
                <input type="checkbox" [checked]="isSelected(fc)" (click)="$event.stopPropagation()" (change)="toggleFileSelection(fc)"/>
                <vscode-badge appearance="secondary">{{ fc.changeType }}</vscode-badge>
                <code style="font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">{{ fc.filePath }}</code>
                <span style="margin-left:auto; color: var(--vscode-descriptionForeground); font-size:12px;">+{{ fc.addedLines }} / -{{ fc.deletedLines }}</span>
              </div>
              <!-- AI comments under the file entry -->
              <ng-container *ngIf="aiCommentsByFile()[fc.filePath]?.length as count">
                <div *ngIf="count > 0" style="display:flex; flex-direction:column; gap:4px; margin:0 0 0 28px;">
                  <div *ngFor="let c of aiCommentsByFile()[fc.filePath]" 
                       (click)="openComment(fc, c)"
                       style="display:flex; align-items:center; gap:8px; padding:6px 8px; border-left:3px solid var(--vscode-panel-border,#333); background: var(--vscode-editor-background); cursor:pointer;">
                    <span class="codicon codicon-lightbulb"></span>
                    <vscode-badge appearance="secondary">{{ c.severity }}</vscode-badge>
                    <code style="font-size:12px;">L{{ c.lineNumber }}</code>
                    <span style="font-size:12px; color: var(--vscode-descriptionForeground); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                      {{ c.content }}
                    </span>
                  </div>
                </div>
              </ng-container>
>>>>>>> 8a6ed91dc61cc80c455d4c05f74d458aee5842a1
            </div>
          </div>

          <!-- Diff viewer -->
          <div style="flex: 1 1 auto; min-height: 420px; max-height: 420px; overflow:hidden; border:1px solid var(--vscode-panel-border,#333); border-radius:4px; background: var(--vscode-editor-background); display:flex; flex-direction:column;">
            <ng-container *ngIf="activeFile(); else noActive">
              <div style="padding:8px; border-bottom:1px solid var(--vscode-panel-border,#333); display:flex; align-items:center; gap:8px;">
                <code style="font-size:12px;">{{ activeFile()?.filePath }}</code>
                <vscode-badge appearance="secondary">{{ activeFile()?.changeType }}</vscode-badge>
                <span style="margin-left:auto; color: var(--vscode-descriptionForeground); font-size:12px;">+{{ activeFile()?.addedLines }} / -{{ activeFile()?.deletedLines }}</span>
                <vscode-button appearance="icon" title="Analyze changed code (AI)" (click)="analyzeActiveFile()" [disabled]="!hasModel() || analysisInProgress()">
                  <span class="codicon codicon-lightbulb"></span>
                </vscode-button>
                <ng-container *ngIf="analysisInProgress()">
                  <vscode-progress-ring></vscode-progress-ring>
                </ng-container>
              </div>
              <div style="flex: 1; min-height: 0;">
                <ng-container *ngIf="fileText()[activeFile()!.filePath] as content; else loadingContent">
                  <ff-monaco-diff-viewer
                    [leftText]="content.left"
                    [rightText]="content.right"
                    [leftLabel]="content.leftPath || 'Original'"
                    [rightLabel]="content.rightPath || 'Modified'"
                    [filePath]="activeFile()!.filePath"
<<<<<<< HEAD
                    [prId]="pr()?.id || 0"
                    [oldFilePath]="activeFile()!.oldFilePath || undefined"
                    [comments]="activeComments()">
=======
                    [lineComments]="activeFileComments()"
                    [revealLine]="focusedLine()"
                    (requestAnalyzeLine)="analyzeLine($event)">
>>>>>>> 8a6ed91dc61cc80c455d4c05f74d458aee5842a1
                  </ff-monaco-diff-viewer>
                </ng-container>
                <ng-template #loadingContent>
                  <div style="height:100%; display:flex; align-items:center; justify-content:center; gap:8px;">
                    <vscode-progress-ring></vscode-progress-ring>
                    <span>Loading file content‚Ä¶</span>
                  </div>
                </ng-template>
              </div>
              <!-- AI Suggestions for active file -->
              <div *ngIf="activeFileComments().length > 0" style="border-top:1px solid var(--vscode-panel-border,#333); padding:8px; max-height:220px; overflow:auto;">
                <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
                  <h5 style="margin:0;">AI Suggestions</h5>
                  <span style="color: var(--vscode-descriptionForeground); font-size:12px;">{{ activeFileComments().length }} suggestion(s)</span>
                </div>
                <div *ngFor="let c of activeFileComments()" style="display:flex; flex-direction:column; gap:4px; padding:8px; border:1px solid var(--vscode-panel-border,#333); border-radius:4px; margin-bottom:6px; background: var(--vscode-editor-background);">
                  <div style="display:flex; align-items:center; gap:8px;">
                    <vscode-badge appearance="secondary">{{ c.severity }}</vscode-badge>
                    <code style="font-size:12px;">Line {{ c.lineNumber }}</code>
                    <span style="margin-left:auto;"></span>
                    <vscode-button appearance="secondary" (click)="postSuggestedComment(c)">Comment</vscode-button>
                  </div>
                  <div style="white-space:pre-wrap;">{{ c.content }}</div>
                  <div *ngIf="c.suggestion" style="white-space:pre-wrap; font-family: var(--vscode-editor-font-family); font-size: 12px; background: var(--vscode-textBlockQuote-background); padding:6px; border-radius:4px;">
                    {{ c.suggestion }}
                  </div>
                </div>
              </div>
            </ng-container>
            <ng-template #noActive>
              <div style="padding:16px; color: var(--vscode-descriptionForeground);">Select a file to view its changes.</div>
            </ng-template>
          </div>
        </div>
      </div>
    </ng-container>
  </ng-template>

  <ng-template #noData>
    <div style="color: var(--vscode-descriptionForeground);">Select a pull request from the dashboard to view details.</div>
  </ng-template>
</section>
