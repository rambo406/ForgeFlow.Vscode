<section class="p-4 flex flex-col gap-4">
  <header class="flex items-center gap-3">
    <vscode-button appearance="secondary" (click)="backToDashboard()">
      ← Back
    </vscode-button>
    <h2 class="m-0 font-semibold">Pull Request Detail</h2>
  </header>

  <ng-container *ngIf="loading(); else content">
    <div class="flex items-center gap-2">
      <vscode-progress-ring></vscode-progress-ring>
      <span>Loading pull request.</span>
    </div>
  </ng-container>

  <ng-template #content>
    <ng-container *ngIf="pr(); else noData">
      <div class="flex flex-col gap-2">
        <div class="flex items-center gap-2 flex-wrap">
          <h3 class="m-0">{{ pr()?.title }}</h3>
          <vscode-badge *ngIf="pr()?.isDraft" appearance="secondary">Draft</vscode-badge>
          <vscode-badge>{{ pr()?.status }}</vscode-badge>
        </div>
        <div class="text-vs-desc text-xs">
          <span>by {{ pr()?.author }}</span>
          <span> • {{ pr()?.repository }}</span>
          <span> • {{ branchSummary() }}</span>
          <span> • {{ pr()?.createdDate | date:'medium' }}</span>
        </div>
        <div class="whitespace-pre-wrap border border-vs-panelBorder p-2 rounded bg-vs-bg">
          {{ pr()?.description || 'No description provided.' }}
        </div>

        <div *ngIf="stats()" class="flex gap-2 flex-wrap">
          <vscode-badge appearance="secondary">Files: {{ stats()?.totalFiles }}</vscode-badge>
          <vscode-badge appearance="secondary">+{{ stats()?.totalAdditions }}</vscode-badge>
          <vscode-badge appearance="secondary">-{{ stats()?.totalDeletions }}</vscode-badge>
          <a *ngIf="pr()?.url" [href]="pr()?.url" target="_blank" class="ml-auto no-underline">
            <vscode-button appearance="secondary">Open in Azure DevOps</vscode-button>
          </a>
        </div>

        <vscode-divider></vscode-divider>

        <h4 class="m-0">Changed Files</h4>
        <div *ngIf="fileChanges().length === 0" class="text-vs-desc">No file changes.</div>

        <div class="flex gap-3">
          <!-- File list -->
          <div class="basis-[380px] grow-0 shrink-0 flex flex-col gap-1.5 max-h-[420px] overflow-auto">
            <div class="flex items-center gap-2">
              <input type="checkbox" id="selectAll" (change)="selectAll($event.target.checked)"/>
              <label for="selectAll" class="text-xs text-vs-desc">Select all</label>
            </div>

            <div *ngFor="let fc of fileChanges()" class="flex flex-col gap-1">
              <div 
                   class="flex items-center gap-2 px-2 py-1.5 border border-vs-panelBorder rounded cursor-pointer bg-vs-bg"
                   (click)="showDiff(fc)">
                <input type="checkbox" [checked]="isSelected(fc)" (click)="$event.stopPropagation()" (change)="toggleFileSelection(fc)"/>
                <vscode-badge appearance="secondary">{{ fc.changeType }}</vscode-badge>
                <code class="text-xs whitespace-nowrap overflow-hidden text-ellipsis">{{ fc.filePath }}</code>
                <span class="ml-auto text-vs-desc text-xs">+{{ fc.addedLines }} / -{{ fc.deletedLines }}</span>
              </div>
              <!-- AI comments under the file entry -->
              <ng-container *ngIf="aiCommentsByFile()[fc.filePath]?.length as count">
                <div *ngIf="count > 0" style="display:flex; flex-direction:column; gap:4px; margin:0 0 0 28px;">
                  <div *ngFor="let c of aiCommentsByFile()[fc.filePath]" 
                       (click)="openComment(fc, c)"
                       style="display:flex; align-items:center; gap:8px; padding:6px 8px; border-left:3px solid var(--vscode-panel-border,#333); background: var(--vscode-editor-background); cursor:pointer;">
                    <span class="codicon codicon-lightbulb"></span>
                    <vscode-badge appearance="secondary">{{ c.severity }}</vscode-badge>
                    <code style="font-size:12px;">L{{ c.lineNumber }}</code>
                    <span style="font-size:12px; color: var(--vscode-descriptionForeground); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                      {{ c.content }}
                    </span>
                  </div>
                </div>
              </ng-container>
            </div>
          </div>

          <!-- Diff viewer -->
          <div style="flex: 1 1 auto; min-height: 420px; max-height: 420px; overflow:hidden; border:1px solid var(--vscode-panel-border,#333); border-radius:4px; background: var(--vscode-editor-background); display:flex; flex-direction:column;">
            <ng-container *ngIf="activeFile(); else noActive">
              <div style="padding:8px; border-bottom:1px solid var(--vscode-panel-border,#333); display:flex; align-items:center; gap:8px;">
                <code style="font-size:12px;">{{ activeFile()?.filePath }}</code>
                <vscode-badge appearance="secondary">{{ activeFile()?.changeType }}</vscode-badge>
                <span style="margin-left:auto; color: var(--vscode-descriptionForeground); font-size:12px;">+{{ activeFile()?.addedLines }} / -{{ activeFile()?.deletedLines }}</span>
                <vscode-button appearance="icon" title="Analyze changed code (AI)" (click)="analyzeActiveFile()" [disabled]="!hasModel() || analysisInProgress()">
                  <span class="codicon codicon-lightbulb"></span>
                </vscode-button>
                <ng-container *ngIf="analysisInProgress()">
                  <vscode-progress-ring></vscode-progress-ring>
                </ng-container>
              </div>
              <div style="flex: 1; min-height: 0;">
                <ng-container *ngIf="fileText()[activeFile()!.filePath] as content; else loadingContent">
                  <ff-monaco-diff-viewer
                    [leftText]="content.left"
                    [rightText]="content.right"
                    [leftLabel]="content.leftPath || 'Original'"
                    [rightLabel]="content.rightPath || 'Modified'"
                    [filePath]="activeFile()!.filePath"
                    [prId]="pr()?.id || 0"
                    [oldFilePath]="activeFile()!.oldFilePath || undefined"
                    [comments]="activeComments()"
                    [lineComments]="activeFileComments()"
                    [revealLine]="focusedLine()"
                    (requestAnalyzeLine)="analyzeLine($event)">
                  </ff-monaco-diff-viewer>
                </ng-container>
                <ng-template #loadingContent>
                  <div style="height:100%; display:flex; align-items:center; justify-content:center; gap:8px;">
                    <vscode-progress-ring></vscode-progress-ring>
                    <span>Loading file content.</span>
                  </div>
                </ng-template>
              </div>
              <!-- AI Suggestions for active file -->
              <div *ngIf="activeFileComments().length > 0" class="border-t border-vs-panelBorder p-2 max-h-[220px] overflow-auto">
                <div class="flex items-center gap-2 mb-1.5">
                  <h5 class="m-0">AI Suggestions</h5>
                  <span class="text-vs-desc text-xs">{{ activeFileComments().length }} suggestion(s)</span>
                </div>
                <div *ngFor="let c of activeFileComments()" class="flex flex-col gap-1 p-2 border border-vs-panelBorder rounded mb-1.5 bg-vs-bg">
                  <div class="flex items-center gap-2">
                    <vscode-badge appearance="secondary">{{ c.severity }}</vscode-badge>
                    <code class="text-xs">Line {{ c.lineNumber }}</code>
                    <span class="ml-auto"></span>
                    <vscode-button appearance="secondary" (click)="postSuggestedComment(c)">Comment</vscode-button>
                  </div>
                  <div class="whitespace-pre-wrap">{{ c.content }}</div>
                  <div *ngIf="c.suggestion" class="whitespace-pre-wrap font-mono text-xs bg-vs-textBlockQuoteBg p-1.5 rounded">
                    {{ c.suggestion }}
                  </div>
                </div>
              </div>
            </ng-container>
            <ng-template #noActive>
              <div class="p-4 text-vs-desc">Select a file to view its changes.</div>
            </ng-template>
          </div>
        </div>
      </div>
    </ng-container>
  </ng-template>

  <ng-template #noData>
    <div class="text-vs-desc">Select a pull request from the dashboard to view details.</div>
  </ng-template>
</section>
