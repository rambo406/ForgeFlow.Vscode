<section>
  <header class="ff-config-header">
    <div>
      <h2 class="ff-config-title">Azure DevOps Connection</h2>
      <p class="ff-config-description">
        Configure your organization URL and Personal Access Token. The token is stored securely using VS Code Secret Storage.
      </p>
    </div>
    <nav>
      <a routerLink="/dashboard" class="ff-link-no-underline">
        <vscode-button appearance="secondary">Back to Dashboard</vscode-button>
      </a>
    </nav>
  </header>

  <vscode-divider></vscode-divider>

  <div class="ff-config-container">
    <label class="ff-label">Organization URL</label>
    <vscode-text-field
      placeholder="https://dev.azure.com/your-org"
      value="{{ organizationUrl() }}"
      (input)="organizationUrl.set($any($event.target).value)"
    ></vscode-text-field>
    <div class="ff-row">
      <vscode-button appearance="secondary" (click)="testOrg()" [disabled]="!organizationUrl() || testingOrg()">
        {{ testingOrg() ? 'Testing…' : 'Test URL' }}
      </vscode-button>
      <ng-container *ngIf="orgResult() as r">
        <vscode-badge appearance="{{ r.success ? 'success' : 'error' }}">{{ r.success ? 'OK' : 'Error' }}</vscode-badge>
        <span class="ff-small-muted">{{ r.message || r.error }}</span>
      </ng-container>
      <ng-container *ngIf="testingOrg()">
        <vscode-progress-ring></vscode-progress-ring>
      </ng-container>
    </div>

    <label class="ff-label" style="margin-top:12px;">Personal Access Token (PAT)</label>
    <div class="ff-flex">
      <vscode-text-field
        style="flex:1;"
        [attr.type]="showPat() ? 'text' : 'password'"
        placeholder="Azure DevOps PAT"
        value="{{ personalAccessToken() }}"
        (input)="personalAccessToken.set($any($event.target).value)"
      ></vscode-text-field>
      <vscode-button appearance="secondary" (click)="showPat.set(!showPat())">{{ showPat() ? 'Hide' : 'Show' }}</vscode-button>
    </div>
    <div class="ff-row">
      <vscode-button appearance="secondary" (click)="testPat()" [disabled]="!organizationUrl() || !personalAccessToken() || testingPat()">
        {{ testingPat() ? 'Validating…' : 'Validate PAT' }}
      </vscode-button>
      <ng-container *ngIf="patResult() as r">
        <vscode-badge appearance="{{ r.success ? 'success' : 'error' }}">{{ r.success ? 'Valid' : 'Invalid' }}</vscode-badge>
        <span class="ff-small-muted">{{ r.message || r.error }}</span>
      </ng-container>
      <ng-container *ngIf="testingPat()">
        <vscode-progress-ring></vscode-progress-ring>
      </ng-container>
    </div>

    <div class="ff-small-muted">
      <vscode-link href="https://learn.microsoft.com/azure/devops/organizations/accounts/use-personal-access-tokens-to-authenticate">How to create a PAT</vscode-link>
    </div>

    <label class="ff-label" style="margin-top:12px;">Default Project (optional)</label>
    <vscode-text-field
      placeholder="Project name"
      value="{{ defaultProject() }}"
      (input)="defaultProject.set($any($event.target).value)"
    ></vscode-text-field>

    <vscode-divider style="margin-top:16px;"></vscode-divider>
    <label class="ff-section-title">AI Model (GitHub Copilot)</label>
    <div class="ff-flex" style="flex-wrap:wrap;">
      <vscode-dropdown
        style="min-width:320px;"
        [disabled]="loadingModels()"
        [value]="selectedModel()"
        (change)="onModelChange($event)">
        <ng-container *ngFor="let m of availableModels()">
          <vscode-option [value]="m.id">{{ m.name }} — {{ m.family }}</vscode-option>
        </ng-container>
      </vscode-dropdown>
      <vscode-button appearance="secondary" (click)="refreshModels()" [disabled]="loadingModels()">{{ loadingModels() ? 'Loading…' : 'Refresh Models' }}</vscode-button>
      <vscode-button appearance="secondary" (click)="testModel()" [disabled]="!hasValidModel() || testingModel()">{{ testingModel() ? 'Testing…' : 'Test Model' }}</vscode-button>
    </div>
    <div class="ff-row">
      <ng-container *ngIf="modelResult() as r">
        <vscode-badge appearance="{{ r.success ? 'success' : 'error' }}">{{ r.success ? 'Available' : 'Unavailable' }}</vscode-badge>
        <span class="ff-small-muted">{{ r.message || r.error }}</span>
      </ng-container>
      <ng-container *ngIf="testingModel()">
        <vscode-progress-ring></vscode-progress-ring>
      </ng-container>
    </div>
  </div>

  <div class="ff-stack">
    <vscode-button appearance="primary" (click)="save()" [disabled]="saving() || !hasValidModel()">{{ saving() ? 'Saving…' : 'Save Configuration' }}</vscode-button>
  </div>

  <div *ngIf="toast() as t" style="margin-top:8px; display:flex; align-items:center; gap:8px;">
    <vscode-badge appearance="{{ t.kind === 'success' ? 'success' : 'error' }}">{{ t.kind === 'success' ? 'Success' : 'Error' }}</vscode-badge>
    <span>{{ t.message }}</span>
  </div>
</section>
