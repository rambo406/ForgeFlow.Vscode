<section class="p-4 flex flex-col gap-4">
  <header class="flex items-center justify-between">
    <div>
      <h2 class="m-0 font-semibold">PR Dashboard</h2>
      <p class="mt-1 text-vs-desc">
        View and analyze your active Azure DevOps pull requests.
      </p>
    </div>
    <nav>
      <a routerLink="/configuration" class="no-underline">
        <vscode-button appearance="secondary">Configuration</vscode-button>
      </a>
    </nav>
  </header>

  <vscode-divider></vscode-divider>

  <div class="flex flex-col gap-3 max-w-[1000px]">
    <div class="flex items-center gap-2">
      <ng-container *ngIf="isConfigured(); else notConfigured">
        <vscode-badge appearance="success">Connected</vscode-badge>
        <span class="text-vs-desc">{{ organizationUrl() }}</span>
      </ng-container>
      <ng-template #notConfigured>
        <vscode-badge appearance="error">Not Configured</vscode-badge>
        <span class="text-vs-desc">Configure your Azure DevOps connection</span>
      </ng-template>
    </div>

    <div class="flex items-center gap-2">
      <vscode-button (click)="loadActivePRs()" [disabled]="!isConfigured() || loadingPRs()">
        {{ loadingPRs() ? 'Loading.' : 'Load Active PRs' }}
      </vscode-button>
      <ng-container *ngIf="loadingPRs()">
        <vscode-progress-ring></vscode-progress-ring>
      </ng-container>
      <ng-container *ngIf="prCount() !== null">
        <vscode-badge appearance="secondary">{{ prCount() }} PRs</vscode-badge>
        <span *ngIf="lastProject()" class="text-vs-desc">in {{ lastProject() }}</span>
      </ng-container>
    </div>

    <!-- Filters Row -->
    <div class="grid [grid-template-columns:1fr_160px_200px_1fr_1fr_auto_auto] gap-2 items-end">
      <div>
        <label class="block text-xs text-vs-desc">Search</label>
        <input type="text" placeholder="Title, description, author." (input)="onSearchInput($any($event.target).value)" class="w-full px-2 py-2 bg-vs-bg text-vs-fg border border-vs-panelBorder rounded" />
      </div>
      <div>
        <label class="block text-xs text-vs-desc">Status</label>
        <select [value]="filters().status" (change)="updateStatus($any($event.target).value)" class="w-full px-2 py-2 bg-vs-bg text-vs-fg border border-vs-panelBorder rounded">
          <option value="all">All</option>
          <option value="active">Active</option>
          <option value="completed">Completed</option>
          <option value="abandoned">Abandoned</option>
        </select>
      </div>
      <div>
        <label class="block text-xs text-vs-desc">Repository</label>
        <select [value]="filters().repositoryId || ''" (change)="updateRepository($any($event.target).value)" class="w-full px-2 py-2 bg-vs-bg text-vs-fg border border-vs-panelBorder rounded">
          <option value="">All</option>
          <option *ngFor="let r of repositories()" [value]="r.id">{{ r.name }}</option>
        </select>
      </div>
      <div>
        <label class="block text-xs text-vs-desc">Author</label>
        <input type="text" [value]="filters().author || ''" (input)="updateAuthor($any($event.target).value)" placeholder="Name or email" class="w-full px-2 py-2 bg-vs-bg text-vs-fg border border-vs-panelBorder rounded" />
      </div>
      <div>
        <label class="block text-xs text-vs-desc">From</label>
        <input type="date" [value]="filters().startDate || ''" (change)="updateStartDate($any($event.target).value)" class="w-full px-2 py-2 bg-vs-bg text-vs-fg border border-vs-panelBorder rounded" />
      </div>
      <div>
        <label class="block text-xs text-vs-desc">To</label>
        <input type="date" [value]="filters().endDate || ''" (change)="updateEndDate($any($event.target).value)" class="w-full px-2 py-2 bg-vs-bg text-vs-fg border border-vs-panelBorder rounded" />
      </div>
      <div class="flex gap-1.5">
        <vscode-button (click)="applyFilters()" [disabled]="applyingFilters()">Apply</vscode-button>
        <vscode-button appearance="secondary" (click)="clearFilters()">Clear</vscode-button>
      </div>
    </div>

    <!-- PR List -->
    <div *ngIf="pullRequests().length > 0" class="flex flex-col gap-2 mt-2">
      <div *ngFor="let pr of pullRequests()" (click)="selectPR(pr.id)" class="cursor-pointer p-3 border border-vs-panelBorder rounded-md bg-vs-bg grid [grid-template-columns:1fr_auto] gap-2 items-center">
        <div>
          <div class="flex items-center gap-2 flex-wrap">
            <span class="font-semibold">{{ pr.title }}</span>
            <vscode-badge *ngIf="pr.isDraft" appearance="secondary">Draft</vscode-badge>
            <vscode-badge>{{ pr.status }}</vscode-badge>
          </div>
          <div class="text-vs-desc text-xs mt-0.5 flex gap-2 flex-wrap">
            <span>{{ pr.repository }}</span>
            <span>• {{ pr.sourceRefName.replace('refs/heads/', '') }} → {{ pr.targetRefName.replace('refs/heads/', '') }}</span>
            <span>• {{ pr.author }}</span>
            <span>• {{ pr.createdDate | date:'medium' }}</span>
          </div>
          <div class="mt-1 text-[var(--vscode-foreground)] opacity-90 overflow-hidden text-ellipsis line-clamp-2">
            {{ pr.description || 'No description provided.' }}
          </div>
        </div>
        <div class="justify-self-end">
          <vscode-button>View</vscode-button>
        </div>
      </div>
    </div>
    <div *ngIf="!loadingPRs() && pullRequests().length === 0 && prCount() !== null" class="text-vs-desc">
      No pull requests match the current criteria.
    </div>
  </div>
</section>
